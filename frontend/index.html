<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Virtual Otorino 3D</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background-color: #121212;
        color: #eee;
      }
      .container {
        display: flex;
        gap: 10px;
        padding: 10px;
      }
      .ear-panel {
        flex: 1;
        background: #1e1e1e;
        padding: 10px;
        border-radius: 6px;
      }
      .ear-panel h3 {
        margin: 5px 0;
      }
      .viewer {
        width: 100%;
        height: 400px;
        border: 1px solid #333;
        background: #000;
      }
      input {
        margin: 3px;
        width: 60px;
        background: #222;
        color: #eee;
        border: 1px solid #555;
        padding: 2px;
        border-radius: 3px;
      }
      button {
        margin: 3px;
        padding: 4px 8px;
        background: #333;
        color: #eee;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #555;
      }
      #info {
        margin: 10px;
        padding: 10px;
        background: #1e1e1e;
        border-radius: 6px;
      }
    </style>
  </head>
  <body>
    <h2 style="text-align: center">Istimo Dual Ear Processor</h2>

    <div class="container">
      <!-- LEFT EAR PANEL -->
      <div class="ear-panel" id="left-ear">
        <h3>Left Ear</h3>
        <input type="file" id="file_left" /><br />
        ROI:<br />
        X: <input id="x_min_left" value="-36" /><input
          id="x_max_left"
          value="-16"
        /><br />
        Y: <input id="y_min_left" value="31" /><input
          id="y_max_left"
          value="45"
        /><br />
        Z: <input id="z_min_left" value="-16" /><input
          id="z_max_left"
          value="-1"
        /><br />
        <button onclick="preview('left')">Preview</button>
        <button onclick="process('left')">Process</button>
        <div class="viewer" id="viewer_left"></div>
        <div id="info_left"></div>
      </div>

      <!-- RIGHT EAR PANEL -->
      <div class="ear-panel" id="right-ear">
        <h3>Right Ear</h3>
        <input type="file" id="file_right" /><br />
        ROI:<br />
        X: <input id="x_min_right" value="-36" /><input
          id="x_max_right"
          value="-16"
        /><br />
        Y: <input id="y_min_right" value="31" /><input
          id="y_max_right"
          value="45"
        /><br />
        Z: <input id="z_min_right" value="-16" /><input
          id="z_max_right"
          value="-1"
        /><br />
        <button onclick="preview('right')">Preview</button>
        <button onclick="process('right')">Process</button>
        <div class="viewer" id="viewer_right"></div>
        <div id="info_right"></div>
      </div>
    </div>

    <!-- JOINT INFO PANEL -->
    <div id="info"></div>

    <script>
      const state = { left: null, right: null };

      function createROIBox(x_min, x_max, y_min, y_max, z_min, z_max) {
        const vertices = [
          [x_min, y_min, z_min],
          [x_max, y_min, z_min],
          [x_max, y_max, z_min],
          [x_min, y_max, z_min],
          [x_min, y_min, z_max],
          [x_max, y_min, z_max],
          [x_max, y_max, z_max],
          [x_min, y_max, z_max],
        ];
        const faces = [
          [0, 1, 2],
          [0, 2, 3],
          [4, 5, 6],
          [4, 6, 7],
          [0, 1, 5],
          [0, 5, 4],
          [1, 2, 6],
          [1, 6, 5],
          [2, 3, 7],
          [2, 7, 6],
          [3, 0, 4],
          [3, 4, 7],
        ];
        return { vertices, faces };
      }

      function plotMesh(mesh, roiBox = null, viewerId = "viewer", title = "") {
        const x = [],
          y = [],
          z = [],
          i = [],
          j = [],
          k = [];
        mesh.vertices.forEach((v) => {
          x.push(v[0]);
          y.push(v[1]);
          z.push(v[2]);
        });
        mesh.faces.forEach((f) => {
          i.push(f[0]);
          j.push(f[1]);
          k.push(f[2]);
        });

        const traces = [
          {
            type: "mesh3d",
            x,
            y,
            z,
            i,
            j,
            k,
            opacity: 0.9,
            color: "purple",
            name: "Mesh",
          },
        ];

        if (roiBox) {
          const bx = [],
            by = [],
            bz = [],
            bi = [],
            bj = [],
            bk = [];
          roiBox.vertices.forEach((v) => {
            bx.push(v[0]);
            by.push(v[1]);
            bz.push(v[2]);
          });
          roiBox.faces.forEach((f) => {
            bi.push(f[0]);
            bj.push(f[1]);
            bk.push(f[2]);
          });
          traces.push({
            type: "mesh3d",
            x: bx,
            y: by,
            z: bz,
            i: bi,
            j: bj,
            k: bk,
            opacity: 0.3,
            color: "red",
            name: "ROI",
          });
        }

        Plotly.newPlot(viewerId, traces, {
          margin: { l: 0, r: 0, t: 30, b: 0 },
          scene: { aspectmode: "data" },
          title,
        });
      }

      function parsePLY(text) {
        const lines = text.split("\n");
        let i = 0,
          nVerts = 0,
          nFaces = 0;
        while (!lines[i].startsWith("end_header")) {
          if (lines[i].startsWith("element vertex"))
            nVerts = parseInt(lines[i].split(" ")[2]);
          if (lines[i].startsWith("element face"))
            nFaces = parseInt(lines[i].split(" ")[2]);
          i++;
        }
        i++;
        const vertices = [],
          faces = [];
        for (let v = 0; v < nVerts; v++, i++)
          vertices.push(lines[i].trim().split(/\s+/).map(Number));
        for (let f = 0; f < nFaces; f++, i++) {
          const parts = lines[i].trim().split(/\s+/).map(Number);
          faces.push(parts.slice(1, 4));
        }
        return { vertices, faces };
      }

      async function preview(side) {
        const fileInput = document.getElementById(`file_${side}`);
        if (!fileInput.files.length) {
          alert("Upload a mesh first");
          return;
        }

        const form = new FormData();
        form.append("file", fileInput.files[0]);
        document.getElementById(`info_${side}`).innerText =
          "Uploading preview...";

        const res = await fetch("/upload_preview", {
          method: "POST",
          body: form,
        });
        const data = await res.json();
        state[side] = { job_id: data.job_id };

        const roiBox = createROIBox(
          parseFloat(document.getElementById(`x_min_${side}`).value),
          parseFloat(document.getElementById(`x_max_${side}`).value),
          parseFloat(document.getElementById(`y_min_${side}`).value),
          parseFloat(document.getElementById(`y_max_${side}`).value),
          parseFloat(document.getElementById(`z_min_${side}`).value),
          parseFloat(document.getElementById(`z_max_${side}`).value),
        );

        plotMesh(
          { vertices: data.vertices, faces: data.faces },
          roiBox,
          `viewer_${side}`,
          `Preview ${side} ear`,
        );
        document.getElementById(`info_${side}`).innerText =
          `Uploaded | Watertight: ${data.watertight} | Faces: ${data.faces_count} | Vertices: ${data.vertices_count}`;
      }

      async function process(side) {
        if (!state[side] || !state[side].job_id) {
          alert("Preview first!");
          return;
        }

        const form = new FormData();
        form.append("job_id", state[side].job_id);
        form.append("x_min", document.getElementById(`x_min_${side}`).value);
        form.append("x_max", document.getElementById(`x_max_${side}`).value);
        form.append("y_min", document.getElementById(`y_min_${side}`).value);
        form.append("y_max", document.getElementById(`y_max_${side}`).value);
        form.append("z_min", document.getElementById(`z_min_${side}`).value);
        form.append("z_max", document.getElementById(`z_max_${side}`).value);

        document.getElementById(`info_${side}`).innerText =
          "Processing ROI & closing...";

        const res = await fetch("/process", {
          method: "POST",
          body: form,
        });
        const data = await res.json();
        state[side].volume = data.volume;
        state[side].watertight = data.watertight;

        const meshRes = await fetch(`/download/${data.job_id}`);
        const blob = await meshRes.blob();
        const text = await blob.text();
        const closedMesh = parsePLY(text);

        plotMesh(closedMesh, null, `viewer_${side}`, `Closed ROI ${side} ear`);

        document.getElementById("info_" + side).innerText =
          `Closed Mesh | Volume: ${Math.abs(data.volume.toFixed(3))} | Watertight: ${data.watertight}`;

        // update joint info at bottom
        // update joint info at bottom
        if (
          state.left &&
          state.right &&
          state.left.volume &&
          state.right.volume
        ) {
          const volLeft = state.left.volume;
          const volRight = state.right.volume;
          const diffPerc = (
            (Math.abs(volLeft - volRight) / ((volLeft + volRight) / 2)) *
            100
          ).toFixed(2);

          document.getElementById("info").innerHTML = `
    <div style="text-align:center; font-size:24px; font-weight:bold; line-height:1.5;">
      Left Ear Volume: ${Math.abs(volLeft.toFixed(3))} <br>
      Right Ear Volume: ${Math.abs(volRight.toFixed(3))} <br>
      Difference: ${diffPerc}% 
    </div>
  `;
        }
      }
    </script>
  </body>
</html>
